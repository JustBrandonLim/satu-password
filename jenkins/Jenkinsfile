pipeline {
    agent any
    
    environment {
        // Define the path to chromedriver as an environment variable
        CHROMEDRIVER_PATH = '/usr/bin/chromedriver'
    }
    stages {
        stage('Clean Up') {
            steps {
                echo "Cleaning up..."
                sh 'docker compose down webapp'
                sh 'docker image prune -f --filter "dangling=true"'
            }
        }
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'docker compose build webapp'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing...'
                dependencyCheck additionalArguments: ''' 
                    -o './'
                    -s './'
                    -f 'ALL' 
                    --prettyPrint''', odcInstallation: 'OWASP Dependency-Check Vulnerabilities'
        
                dependencyCheckPublisher pattern: 'dependency-check-report.xml'
            }
        }
    
        stage('Selenium UI Test') {
            steps {
                echo 'Running Selenium Tests...'
                // Activate the virtual environment and run the test script
                // Pass the CHROMEDRIVER_PATH environment variable to the script
                script {
                    sh '''
                    source /home/student50/selenium_test/venv/bin/activate
                    CHROMEDRIVER_PATH=${CHROMEDRIVER_PATH} python /home/student50/selenium_test/login_test.py
                    '''
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'Deploying...'
                sh 'docker compose up webapp -d'
                sh 'docker exec webapp cp /env/.env /app'
                sh 'docker exec webapp yarn prisma db push'
            }
        }
    }
}
