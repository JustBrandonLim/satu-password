pipeline {
    agent any

    stages {
        stage('Clean Up') {
            steps {
                echo "Cleaning up..."
                sh 'docker compose down webapp'
                sh 'docker image prune -f --filter "dangling=true"'
            }
        }
        stage('Build') {
            steps {
                echo 'Building...'
                sh 'docker compose build webapp'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing...'
                dependencyCheck additionalArguments: ''' 
                    -o './'
                    -s './'
                    -f 'ALL' 
                    --prettyPrint''', odcInstallation: 'OWASP Dependency-Check Vulnerabilities'
        
                dependencyCheckPublisher pattern: 'dependency-check-report.xml'
            }
        }
        
        stage('Selenium UI Test') {
            steps {
                echo 'Running Selenium Tests...'
                sh 'source /home/student50/selenium_test/venv/bin/activate'
                dir('/home/student50/selenium_test') {
                    // Run the Selenium test script
                    sh 'python login_test.py'
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'Deploying...'
                sh 'docker compose up webapp -d'
                sh 'docker exec webapp cp /env/.env /app'
                sh 'docker exec webapp yarn prisma db push'
            }
        }
    }
}
